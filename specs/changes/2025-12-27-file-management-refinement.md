# 変更記録: 画像圧縮と AI 生成アセット管理の導入

## 1. 変更の理由 (Reason)

1.  **ストレージの最適化**: 
    高画質な画像や大量の添付ファイルは IndexedDB の容量を圧迫するため、保存前に適切な圧縮（リサイズ、画質調整）を行う必要がある。
2.  **AI 生成画像の永続化**: 
    DALL-E 3 等のツールによって生成された画像を、一時的な表示だけでなく、チャット履歴のアセットとして安全に保存・管理するため。
3.  **プライバシーとポータビリティ**: 
    物理ファイルシステムに依存せず、すべてのデータを IndexedDB に集約することで、バックアップや将来的な Web 移行を容易にするため。

## 2. 変更内容 (Changes)

### 2.1 機能の追加
- **自動画像圧縮**: アップロード時に Canvas API を使用して、指定された解像度（例: 長辺 1536px）かつ画質（例: JPEG 0.8）に自動変換。
- **AI アセット保存フロー**: LLM のレスポンスに含まれる画像データ（Base64/URL）を検知し、自動的に `db.files` へ保存するロジックの追加。

### 2.2 技術的変更
- **Storage Strategy**: ハイブリッド（物理FS併用）案を廃止し、**IndexedDB (Dexie) のみに完全移行**。
- **Service Layer**: `FileService` に圧縮、Base64 変換、AI アセット取得の各メソッドを追加。
- **Chat Layer**: `ChatService` におけるマルチモーダル・メッセージング（Content Array 形式）のサポート。

### 2.3 データモデルの更新
- `LocalFile`: `isGenerated` (AI生成フラグ)、`originalSize`、`compressedSize` フィールドの追加。
- `Message`: 画像アセットとのリレーション管理。
