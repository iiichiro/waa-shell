# 要件定義書

## 1. プロジェクト概要

本アプリケーション「Waa-Shell」は、Tauri を基盤としたデスクトップ向けチャットプラットフォームであり、複数の生成 AI モデル（LLM）をローカル環境から安全かつ高速に活用できることを目的とする。
ユーザーは自らのニーズに合わせて AI モデルを選択・設定し、テキストやファイル（画像含む）を用いた対話を行うことができる。
データ保存はブラウザの IndexedDB を利用し、プライバシーとオフライン動作を重視した「ローカルファースト」な設計を採用する。

## 2. 機能要件

### 2.1 ユーザー認証・管理

- **ローカル管理**: デスクトップアプリとして動作し、API キーや会話履歴はユーザーのローカル環境（IndexedDB/LocalStorage）に保存される。
- **外部サービス連携**: 必要に応じて OAuth 2.0 等を用いた外部サービス（MCP サーバ等）との認可連携を行う。

### 2.2 チャット機能

- **リアルタイム対話**: AI からの応答を逐次表示（ストリーミング）し、スムーズな対話体験を提供する。
- **マルチモーダル入力**: テキストに加え、画像ファイルなどの添付（Vision 機能）に対応する。
- **リッチテキスト表示**: Markdown 記法、数式（KaTeX 等）、ソースコード（シンタックスハイライト付き）のレンダリングに対応する。
- **思考プロセス表示**: AI が回答に至るまでの「思考（Reasoning）」を出力する場合、それをユーザーに表示する（開閉可能など）。
- **コンテキスト管理**: 過去の会話履歴を AI のコンテキストとして送信し、文脈を踏まえた対話を実現する。
- **中断・再生成**: 生成中の回答の中断や、同じプロンプトでの再生成を可能にする。

### 2.3 スレッド管理

- **スレッド管理**: 会話を「スレッド」として保存し、タイトル（自動生成または手動）で管理する。
- **履歴検索・閲覧**: 過去のスレッドを一覧表示し、いつでも会話を再開できる。

### 2.4 AI モデル・アシスタント管理

- **マルチモデル対応**: OpenAI API 互換インターフェースを持つ LLM プロバイダー、およびその他主要な商用 AI モデル API に対応する。
- **カスタムモデル設定**: ユーザーが独自のモデル定義（名前、モデル ID、API エンドポイントなど）を追加・保存できる。
- **アシスタント機能**: 特定のシステムプロンプト（指示書）やモデル設定をプリセットした「アシスタント」を作成・保存・切り替えできる。
- **パラメータ調整**: モデルごとに最大トークン数、コンテキストウィンドウサイズなどのパラメータを調整できる。

### 2.5 外部連携・拡張機能 (MCP)

- **MCP (Model Context Protocol) 対応**: 標準化されたプロトコル (MCP) に準拠した外部サーバと接続し、AI にツール（機能）を提供できる。
- **ツール実行**: AI が対話中に必要に応じてツール（Web 検索、計算、DB 操作など）を自律的に呼び出し、その結果を回答に反映する。
- **サーバ管理**: MCP サーバの接続設定（URL、認証情報）を管理できる。

### 2.6 ファイル管理

- **ファイルアップロード**: チャットで使用する画像やドキュメントをアップロードし、管理する。
- **ファイル参照**: アップロード済みのファイルをスレッド内のメッセージに紐付け、AI に参照させる。

### 2.7 コスト・トークン管理

- **トークン計数**: プロンプト（入力）と完了（出力）のトークン数を正確に記録する。
- **コスト試算**: モデルごとの単価設定に基づき、対話やスレッドごとの概算コストを計算・表示する。
- **使用量可視化**: トークン使用量やコストの統計を確認できる。

### 2.8 設定・カスタマイズ

- **API キー管理**: プロバイダーごとの API キーをユーザー自身が安全に登録・更新できる。
- **言語設定**: インターフェースの多言語切り替え（i18n）に対応する。
- **テーマ設定**: ダークモード/ライトモードなどの表示テーマに対応する。

### 2.9 ランチャーモード (Raycast 風)

- **グローバルショートカット**: アプリがバックグラウンドにある場合でも、任意のキーコンビネーション（`Ctrl+Alt+A`）で即座にウィンドウを前面表示・フォーカスする。
- **トグル動作**: 表示中に再度ショートカットを押下、または `Esc` キーでウィンドウを隠す/最小化する。
- **クイック入力**: 起動時に即座に入力フィールドにフォーカスが当たり、対話を開始できる。

### 2.10 スラッシュコマンド（動的プロンプトテンプレート）

- **テンプレート管理**: ユーザーは独自のスラッシュコマンド（`/name`）を作成・保存・編集できる。
  - **管理画面**: コマンド一覧の閲覧、新規登録、編集、削除ができる専用の管理画面を提供する。
  - **データ永続化**: すべてのテンプレートと変数の設定は IndexedDB に保存される。
- **変数埋め込み**: プロンプト内に `{{変数名}}` 形式で変数を記述できる。
- **自動検出**: プロンプト入力中に `{{...}}` 形式を検知し、変数の定義がない場合は自動的にメタデータ入力を促す、またはデフォルトの入力フィールドを生成する。
- **変数のメタデータ**: 各変数には「表示名」「説明」「初期値」を組み合わせて定義できる。
- **同期置換**: 同じ変数名が複数箇所にある場合、一つの入力フィールドで全てを同時に置換できる。
- **入力UI**: コマンド選択後、変数の入力フォームを表示し、確定後に最終的なプロンプトをチャットへ挿入する。

## 3. 非機能要件

- **レスポンシブデザイン**: PC、タブレット、スマートフォンなど、多様なデバイスサイズで最適に表示されること。
- **データ永続性**: ユーザーデータはリレーショナルデータベースに安全に永続化されること。
- **拡張性**: 新しい AI モデルやプロバイダーが登場した際に、容易に追加対応できるアーキテクチャであること。
